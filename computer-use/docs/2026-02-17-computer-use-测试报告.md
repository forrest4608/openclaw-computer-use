# 🖥️ Computer Use 技能开发与测试报告

> **日期**：2026年2月17日
> **作者**：AI Agent (Antigravity) + 刘志刚
> **项目**：macOS 桌面自动化 — Computer Use 技能

---

## 一、项目目标

开发一套 **macOS 桌面自动化技能 (Computer Use)**，让 AI Agent 能够通过"看屏幕 → 理解内容 → 操作鼠标键盘 → 验证结果"的闭环方式，**非侵入式**地控制和操作 macOS 上的任意应用程序。

核心理念：
```
📸 截屏 → 🧠 AI 视觉分析 → 🖱️ 鼠标/键盘操作 → 🔄 验证结果
```

---

## 二、技术架构

### 2.1 技术栈

| 组件 | 工具 | 用途 |
|------|------|------|
| 截屏 | `screencapture` (macOS 内置) | 全屏/区域截图 |
| 鼠标控制 | `cliclick` (第三方) | 点击、拖拽、移动 |
| 键盘控制 | `cliclick` + `osascript` | 打字、快捷键 |
| 窗口管理 | `osascript` (AppleScript) | 聚焦、移动、调整窗口 |
| 系统信息 | `system_profiler` + `osascript` | 分辨率、前台应用等 |

### 2.2 开发的脚本工具

所有脚本位于 `computer-use/scripts/` 目录下：

| 脚本 | 功能 | 用法示例 |
|------|------|---------|
| `screenshot.sh` | 截屏 | `bash screenshot.sh` 或 `bash screenshot.sh 0,0,800,600` |
| `click.sh` | 鼠标操作 | `bash click.sh click 400 300` |
| `type-text.sh` | 键盘输入 | `bash type-text.sh type "Hello"` |
| `window-control.sh` | 窗口管理 | `bash window-control.sh focus "Finder"` |
| `get-screen-info.sh` | 获取屏幕信息 | `bash get-screen-info.sh` |

---

## 三、测试过程与结果

### 3.1 基础功能验证 ✅

#### 截屏功能
- 使用 `screenshot.sh` 成功截取全屏图像
- 截图自动保存到 `/tmp/computer-use/` 目录，带时间戳命名
- 支持指定区域截屏

#### 屏幕信息获取
- `get-screen-info.sh` 成功获取：
  - 显示器分辨率
  - 当前鼠标坐标
  - 前台活动应用名
  - 当前窗口标题

#### 窗口管理
- 成功聚焦 Finder 应用并打开新窗口
- 通过截图验证窗口确实切到前台

### 3.2 端到端测试 — TextEdit ✅

完成了完整的自动化流程：

1. **创建文档** — 使用 `osascript` 打开 TextEdit 并新建空白文档
2. **定位光标** — 使用 `click.sh` 点击编辑区域 (400, 300)
3. **输入文字** — 使用 `cliclick` 输入 "Hello! This is Computer Use in action."
4. **截图验证** — 截屏确认文字成功写入

> ✅ **结果**：TextEdit 中成功显示了输入的文字，端到端流程完全跑通。

### 3.3 WPS Office 文档操作 ⚠️

**目标**：打开 WPS 中的文档"2026年黄埔区高质量发展大会数字电网对接活动方案"，将"黄埔区"替换为"白云区"。

**执行情况**：
- ✅ 成功激活 WPS 应用并显示文档内容
- ✅ 截屏确认文档标题和内容正确
- ⚠️ `Cmd+H` 快捷键被 macOS 截获为"隐藏窗口"，未能打开查找替换对话框
- ⚠️ VS Code 终端焦点抢夺导致操作目标偏移

### 3.4 企业微信搜索操作 ⚠️

**目标**：在企业微信搜索框中搜索"前沿实验室"群。

**执行情况**：
- ✅ 成功激活企业微信，界面完整显示
- ✅ 使用 `Cmd+F` 成功打开搜索面板（出现全局搜索和智能搜索选项）
- ⏳ 中文输入和后续搜索操作待完成

---

## 四、发现的关键问题

### 4.1 🔴 VS Code 焦点抢夺

**问题**：命令在 VS Code 集成终端中执行，每次命令完成后 VS Code 自动获得焦点，导致后续的鼠标/键盘操作作用在 VS Code 上而非目标应用。

**影响**：所有需要连续操作的场景都会受影响。

**建议方案**：
- 将多步操作封装在同一个 `osascript` 脚本中执行
- 使用外部终端而非 VS Code 集成终端
- 在每次操作前显式重新激活目标应用

### 4.2 🟡 macOS 快捷键冲突

**问题**：`Cmd+H` 在 macOS 中是系统级"隐藏窗口"快捷键，优先于应用内的快捷键。

**建议方案**：
- 通过应用菜单栏路径触发功能（更可靠）
- 预先整理各应用的快捷键映射表
- 使用 AppleScript `click menu item` 替代键盘快捷键

### 4.3 🟡 中文输入法干扰

**问题**：macOS 系统输入法（如中文拼音）会拦截 `cliclick` 的字符输入，导致输出异常。

**建议方案**：
- 操作前临时切换为英文输入法
- 使用剪贴板 + `Cmd+V` 粘贴中文文本
- 通过 `osascript` 的 `keystroke` 配合 `using` 参数

### 4.4 🟢 Accessibility 权限

**说明**：`cliclick` 和 `osascript` 的键盘/鼠标控制需要手动在"系统设置 → 隐私与安全性 → 辅助功能"中授权终端应用。这是一次性操作。

---

## 五、技能文件清单

```
computer-use/
├── SKILL.md                    # 技能说明文档
├── scripts/
│   ├── screenshot.sh           # 截屏工具
│   ├── click.sh                # 鼠标点击工具
│   ├── type-text.sh            # 键盘输入工具
│   ├── window-control.sh       # 窗口管理工具
│   └── get-screen-info.sh      # 屏幕信息获取
└── docs/
    └── 2026-02-17-computer-use-测试报告.md  # 本文档
```

---

## 六、下一步计划

| 优先级 | 任务 | 说明 |
|--------|------|------|
| 🔴 高 | 焦点管理优化 | 封装操作到单一 osascript，避免焦点丢失 |
| 🔴 高 | 中文输入支持 | 实现剪贴板粘贴方案，绕过输入法问题 |
| 🟡 中 | 快捷键修复 | 修复 `type-text.sh` 的 shortcut 解析逻辑 |
| 🟡 中 | 应用快捷键映射 | 建立常用应用快捷键差异对照表 |
| 🟢 低 | AI 视觉定位 | 集成 AI 视觉模型自动识别 UI 元素坐标 |
| 🟢 低 | 错误恢复机制 | 操作失败后的自动重试和回滚 |

---

## 七、结论

Computer Use 技能的**基础框架已验证可用**。截屏、鼠标控制、键盘输入、窗口管理四大核心模块均可正常工作。TextEdit 端到端测试**完全成功**，证明了"AI Agent 操控桌面应用"的可行性。

主要瓶颈集中在**焦点管理**和**中文输入**两个环节，这些是 macOS 平台特有的挑战，通过 AppleScript 封装和剪贴板方案可以有效解决。

> 💡 **核心价值**：通过 Computer Use 技能，AI Agent 可以像人一样"看屏幕、动鼠标、敲键盘"，实现对任意 macOS 应用的自动化操控，无需应用提供 API 接口。
